(function($){var console=window.console||{};console.error=window.console.error||function(){};window.fg=function(fgObj){var self={};var varPrivate={};self.properties={ssl:'http',env:'api',apiBase:'.fairgarage.de/smp/api/',languageCode:'de',countryCode:'DE'};self.setProperties=function(newProperties){$.extend(self.properties,newProperties);};self.setProperties(fgObj);self.getProperty=function(propertyName){return self.properties[propertyName];};self.removeProperties=function(properties){$.each(properties,function(){delete self.properties[this.toString()];});};self.api=function(obj){var functionName=obj.functionName||'api()';var type=obj.type||'GET';var urlParam=obj.urlParam||{};var url=(($.inArray(self.getProperty('ssl'),['http','https'])>=0)?self.getProperty('ssl'):'http')+'://'+self.getProperty('env')+self.getProperty('apiBase')+(obj.apiUrl||'authentication/login')+(varPrivate.sessionId?';jsessionid='+varPrivate.sessionId:'')+('?'+$.param($.extend({contextKey:self.getProperty('contextKey')},urlParam)));var error=obj.error||function(jqXHR,textStatus,errorThrown){try{var errMsg=[];$.each(jqXHR.responseJSON,function(){var temp;if(this.field){temp=this.field.split('.')[1]||this.field.split('.')[0]+' of the payload'+(this.errorMessage?', '+this.errorMessage:' error');}else{temp=this.errorMessage;}
errMsg.push(temp);});self.error('Network Error: '+textStatus+', '+errorThrown+'. '+errMsg.join('; '));}catch(err){self.error('Error in FairGarage API when trying to use function '+functionName);}};var ajaxObj={crossDomain:true,type:type,async:obj.async||true,cache:obj.cache||false,url:url,contentType:obj.contentType||'application/json;charset=UTF-8',dataType:obj.dataType||'json',data:obj.data||'',error:error};ajaxObj=$.extend(obj,ajaxObj);$.ajax(ajaxObj);};self.error=function(str){console.error(str);};self.getFirstDateInConstructionTimeMap=function(constructionTimeMap){var years=[];for(var year in constructionTimeMap){years.push(year);}
var thisYear=years.sort()[0];return(thisYear+'-'+('0'+constructionTimeMap[thisYear].sort(function(a,b){return a-b;})[0]).slice(-2)+'-01');};self.dateToTimestamp=function(date){if(!(/\d{4}\-\d{2}\-01/.test(date)||/\d{4}\-\d{1}\-01/.test(date))){return self.error('Please write the date in the format YYYY-MM-01, e.g. "2008-01-01"');}
var year=date.split('-')[0];var month=parseInt(date.split('-')[1])-1;return(new Date(year,month)).getTime();};self.timestampToDate=function(timestamp){var time=new Date(timestamp);var year=time.getFullYear();var month=time.getMonth()+1;var date=year+'-'+('0'+month).slice(-2)+'-01';return date;};self.login=function(pobj){if(typeof pobj=='undefined'){pobj={};}
var paramMissingHint=[];var ajax=pobj.ajax||{};var newAgreements=pobj.newAgreements;if(typeof newAgreements=='undefined'){paramMissingHint.push('"newAgreements" of type "function(data)"');newAgreements='';}
var loginData=pobj.loginData;if(typeof loginData=='undefined'){paramMissingHint.push('"loginData" of type "object"');loginData={};}
if(typeof loginData.username=='undefined'){paramMissingHint.push('"username" of type "string" in "loginData"');}
if(typeof loginData.password=='undefined'){paramMissingHint.push('"password" of type "string" in "loginData"');}
var quickHandle=pobj.quickHandle;if(paramMissingHint.length>0){self.error('Please indicate in function login(): '+paramMissingHint.join(', '));return;}
var success=ajax.success;var complete=ajax.complete;varPrivate.loginArguments=arguments[0];var obj={data:JSON.stringify(loginData),type:'PUT',success:function(data){varPrivate.sessionId=data.user.sessionId;if(typeof quickHandle=='function'){var newData={authorities:[],emailAddress:data.user.emailAddress,givenname:data.user.givenname,middlename:data.user.middlename,surname:data.user.surname};$.each(data.user.authorities,function(){newData.authorities.push(this.authority);});quickHandle(newData);}
if(typeof success=='function'){success(data);}},complete:function(jqXHR,textStatus){var data=jqXHR.responseJSON;if(textStatus=='error'&&(data.agreementVersionsAdded||data.agreementVersionsUpdated)){var newData={addedAgreements:[],updatedAgreements:[]};var agreementVersions=[];$.each(data.agreementVersionsAdded,function(){newData.addedAgreements.push({agreementId:this.agreementId,title:this.title,htmlText:this.text});agreementVersions.push({agreementId:this.agreementId,providerId:this.providerId,agreementVersionId:this.id});});$.each(data.agreementVersionsUpdated,function(){newData.updatedAgreements.push({agreementId:this.agreementId,title:this.title,htmlText:this.text});agreementVersions.push({agreementId:this.agreementId,providerId:this.providerId,agreementVersionId:this.id});});varPrivate.loginArguments.loginData.agreementVersions=agreementVersions;self.loginAgain=function(){if(varPrivate.loginArguments){self.login(varPrivate.loginArguments);}else{self.error('Please use the login() function to retry your authentication.');}};newData.loginAgain=function(){self.loginAgain();};newAgreements(newData);return;}else{delete varPrivate.loginArguments;}
if(typeof complete=='function'){complete(jqXHR,textStatus);}},functionName:'login()'};delete ajax.success;delete ajax.complete;self.api($.extend(obj,ajax));};self.findLocation=function(pobj){if(typeof pobj=='undefined'){pobj={};}
var ajax=pobj.ajax||{};var criteria=pobj.criteria;var obj={apiUrl:'locations',urlParam:$.extend({context:self.getProperty('contextKey')},criteria),functionName:'findLocation()'};self.api($.extend(obj,ajax));};return self;};})(jQuery);